<!DOCTYPE html>
<html>
<head>
    <title>Fix Audio URLs</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>Correction des URLs Audio</h1>
    <button onclick="fixAudioUrls()">Corriger les URLs Audio</button>
    <div id="status"></div>
    
    <script>
    async function fixAudioUrls() {
        const status = document.getElementById('status');
        status.innerHTML = 'Chargement...';
        
        try {
            // Charger app.js et les dépendances
            await loadScript('/js/app.js');
            
            // Initialiser l'app
            await window.app.init();
            
            // Charger les données
            const data = await window.app.storage.load();
            
            status.innerHTML = `Trouvé ${data.news.length} news, ${data.animations.length} animations<br>`;
            
            // Parcourir toutes les news
            for (const news of data.news) {
                if (news.sounds && news.sounds.length > 0) {
                    status.innerHTML += `<br>News "${news.title}" a ${news.sounds.length} sons`;
                    
                    for (const sound of news.sounds) {
                        if (sound.audioFileId) {
                            // Vérifier si le fichier existe
                            const url = `https://saint-esprit-audio.s3.eu-west-3.amazonaws.com/audio/${window.app.storage.userId}/${sound.audioFileId}`;
                            
                            try {
                                const response = await fetch(url, { method: 'HEAD' });
                                if (response.ok) {
                                    status.innerHTML += `<br>✅ ${sound.name} existe déjà`;
                                } else {
                                    status.innerHTML += `<br>❌ ${sound.name} n'existe pas sur S3`;
                                    
                                    // Si on a les données audio en local, les ré-uploader
                                    if (sound.audioFile) {
                                        status.innerHTML += ' - Tentative de ré-upload...';
                                        try {
                                            await window.app.storage.saveAudioFile(sound.audioFileId, sound.audioFile);
                                            status.innerHTML += ' ✅ Uploadé!';
                                        } catch (e) {
                                            status.innerHTML += ` ❌ Erreur: ${e.message}`;
                                        }
                                    }
                                }
                            } catch (e) {
                                status.innerHTML += `<br>⚠️ Erreur vérification ${sound.name}: ${e.message}`;
                            }
                        }
                    }
                }
            }
            
            // Même chose pour les animations
            for (const animation of data.animations) {
                if (animation.sounds && animation.sounds.length > 0) {
                    status.innerHTML += `<br>Animation "${animation.title}" a ${animation.sounds.length} sons`;
                    
                    for (const sound of animation.sounds) {
                        if (sound.audioFileId) {
                            const url = `https://saint-esprit-audio.s3.eu-west-3.amazonaws.com/audio/${window.app.storage.userId}/${sound.audioFileId}`;
                            
                            try {
                                const response = await fetch(url, { method: 'HEAD' });
                                if (response.ok) {
                                    status.innerHTML += `<br>✅ ${sound.name} existe déjà`;
                                } else {
                                    status.innerHTML += `<br>❌ ${sound.name} n'existe pas sur S3`;
                                    
                                    if (sound.audioFile) {
                                        status.innerHTML += ' - Tentative de ré-upload...';
                                        try {
                                            await window.app.storage.saveAudioFile(sound.audioFileId, sound.audioFile);
                                            status.innerHTML += ' ✅ Uploadé!';
                                        } catch (e) {
                                            status.innerHTML += ` ❌ Erreur: ${e.message}`;
                                        }
                                    }
                                }
                            } catch (e) {
                                status.innerHTML += `<br>⚠️ Erreur vérification ${sound.name}: ${e.message}`;
                            }
                        }
                    }
                }
            }
            
            status.innerHTML += '<br><br>✅ Terminé!';
            
        } catch (error) {
            status.innerHTML = `Erreur: ${error.message}`;
            console.error(error);
        }
    }
    
    function loadScript(src) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }
    </script>
</body>
</html>